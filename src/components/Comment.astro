<div id="tcomment" class="twikoo-container">
  <!-- åŠ è½½å ä½ç¬¦ - çº¯ CSS å®ç°ï¼Œé›¶ JS å¼€é”€ -->
  <div class="twikoo-skeleton" id="twikoo-loading">
    <div class="skeleton-header">
      <div class="skeleton-avatar"></div>
      <div class="skeleton-info">
        <div class="skeleton-line short"></div>
        <div class="skeleton-line shorter"></div>
      </div>
    </div>
    <div class="skeleton-content">
      <div class="skeleton-line"></div>
      <div class="skeleton-line medium"></div>
    </div>
    <div class="skeleton-actions">
      <div class="skeleton-btn"></div>
      <div class="skeleton-btn"></div>
    </div>
  </div>
  <!-- é”™è¯¯æç¤ºå®¹å™¨ -->
  <div class="twikoo-error" id="twikoo-error" style="display: none;">
    <div class="error-icon">ğŸ’¬</div>
    <div class="error-title">è¯„è®ºåŠ è½½å¤±è´¥</div>
    <div class="error-desc">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</div>
    <button class="error-retry" onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
  </div>
</div>

<script is:inline>
(function() {
  'use strict';
  
  // é…ç½®
  var CONFIG = {
    envId: 'https://plbt.hhj520.top/',
    el: '#tcomment',
    lang: 'zh-CN',
    scriptUrl: 'https://s4.zstatic.net/npm/twikoo@1.6.44/dist/twikoo.min.js'
  };
  
  // å½“å‰é¡µé¢è·¯å¾„ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
  var currentPath = location.pathname;
  
  // éšè—åŠ è½½å ä½ç¬¦
  function hideLoading() {
    var loadingEl = document.getElementById('twikoo-loading');
    if (loadingEl) {
      loadingEl.style.opacity = '0';
      setTimeout(function() {
        loadingEl.style.display = 'none';
      }, 300);
    }
  }
  
  // æ˜¾ç¤ºåŠ è½½å ä½ç¬¦ï¼ˆç”¨äºé‡æ–°åˆå§‹åŒ–ï¼‰
  function showLoading() {
    var loadingEl = document.getElementById('twikoo-loading');
    if (loadingEl) {
      loadingEl.style.display = 'block';
      loadingEl.style.opacity = '1';
    }
  }
  
  // æ˜¾ç¤ºé”™è¯¯æç¤º
  function showError() {
    hideLoading();
    var errorEl = document.getElementById('twikoo-error');
    if (errorEl) {
      errorEl.style.display = 'block';
    }
  }
  
  // éšè—é”™è¯¯æç¤º
  function hideError() {
    var errorEl = document.getElementById('twikoo-error');
    if (errorEl) {
      errorEl.style.display = 'none';
    }
  }
  
  // æ¸…ç†å·²å­˜åœ¨çš„ Twikoo å®ä¾‹
  function cleanupTwikoo() {
    var container = document.getElementById('tcomment');
    if (container) {
      // ä¿ç•™éª¨æ¶å±å’Œé”™è¯¯æç¤ºï¼Œæ¸…ç†å…¶ä»–å†…å®¹
      var children = container.children;
      for (var i = children.length - 1; i >= 0; i--) {
        var child = children[i];
        if (child.id !== 'twikoo-loading' && child.id !== 'twikoo-error') {
          container.removeChild(child);
        }
      }
    }
    // é‡ç½® twikoo å…¨å±€çŠ¶æ€
    if (window.twikoo) {
      window.twikoo = undefined;
    }
  }
  
  // åˆå§‹åŒ– Twikoo
  function initTwikoo() {
    var container = document.getElementById('tcomment');
    if (!container) return;
    
    // æ£€æŸ¥è·¯å¾„æ˜¯å¦å˜åŒ–ï¼ˆSwup é¡µé¢åˆ‡æ¢åï¼‰
    if (currentPath !== location.pathname) {
      currentPath = location.pathname;
      cleanupTwikoo();
      showLoading();
      hideError();
    }
    
    // è®¾ç½®åŠ è½½è¶…æ—¶
    var loadTimeout = setTimeout(function() {
      console.error('[Twikoo] Load timeout');
      showError();
    }, 10000); // 10ç§’è¶…æ—¶
    
    // åŠ è½½ Twikoo
    if (typeof twikoo === 'undefined') {
      var script = document.createElement('script');
      script.src = CONFIG.scriptUrl;
      script.async = true;
      script.onload = function() {
        clearTimeout(loadTimeout);
        runTwikoo();
      };
      script.onerror = function() {
        clearTimeout(loadTimeout);
        console.error('[Twikoo] Failed to load script');
        showError();
      };
      document.head.appendChild(script);
    } else {
      clearTimeout(loadTimeout);
      runTwikoo();
    }
  }
  
  function runTwikoo() {
    try {
      if (typeof twikoo === 'undefined' || typeof twikoo.init !== 'function') {
        console.error('[Twikoo] twikoo object not available');
        showError();
        return;
      }
      
      var initResult = twikoo.init({
        envId: CONFIG.envId,
        el: CONFIG.el,
        path: location.pathname,
        lang: CONFIG.lang
      });
      
      // å¤„ç† Promise è¿”å›å€¼
      if (initResult && typeof initResult.then === 'function') {
        initResult.then(function() {
          console.log('[Twikoo] Initialized successfully');
          setTimeout(hideLoading, 500);
        }).catch(function(e) {
          console.error('[Twikoo] Init promise error:', e);
          showError();
        });
      } else {
        // é Promise è¿”å›å€¼ï¼Œç›´æ¥è®¤ä¸ºæˆåŠŸ
        console.log('[Twikoo] Initialized (sync)');
        setTimeout(hideLoading, 500);
      }
    } catch (e) {
      console.error('[Twikoo] Init error:', e);
      showError();
    }
  }
  
  // ä½¿ç”¨ Intersection Observer å»¶è¿ŸåŠ è½½
  var observer = null;
  function setupObserver() {
    if (observer) {
      observer.disconnect();
    }
    
    if ('IntersectionObserver' in window) {
      observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            initTwikoo();
            observer.disconnect();
          }
        });
      }, { 
        rootMargin: '200px',
        threshold: 0
      });
      
      var container = document.getElementById('tcomment');
      if (container) {
        observer.observe(container);
      }
    } else {
      // é™çº§å¤„ç†
      initTwikoo();
    }
  }
  
  // åˆå§‹è®¾ç½®
  setupObserver();
  
  // ç›‘å¬ Swup é¡µé¢åˆ‡æ¢äº‹ä»¶
  document.addEventListener('swup:page:view', function() {
    // è·¯å¾„å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
    if (currentPath !== location.pathname) {
      currentPath = location.pathname;
      cleanupTwikoo();
      showLoading();
      hideError();
      setupObserver();
    }
  });
})();
</script>

<style scoped>
.twikoo-container {
  margin-top: 2rem;
  padding: 1.5rem;
  background-color: var(--card-bg);
  border-radius: var(--radius-large);
  border: 1px solid var(--line-divider);
  min-height: 200px;
  /* CSS containment é˜²æ­¢å¸ƒå±€æŠ–åŠ¨ */
  contain: layout style;
  /* å¹³æ»‘è¿‡æ¸¡ */
  transition: min-height 0.3s ease;
}

/* åŠ è½½å ä½ç¬¦æ ·å¼ - çº¯ CSS å®ç° */
.twikoo-skeleton {
  padding: 1rem 0;
  transition: opacity 0.3s ease;
}

.skeleton-header {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  gap: 0.75rem;
}

.skeleton-avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: linear-gradient(90deg, var(--btn-bg) 25%, var(--btn-hover-bg) 50%, var(--btn-bg) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  flex-shrink: 0;
}

.skeleton-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.skeleton-line {
  height: 0.875rem;
  background: linear-gradient(90deg, var(--btn-bg) 25%, var(--btn-hover-bg) 50%, var(--btn-bg) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: 0.25rem;
}

.skeleton-line.short {
  width: 30%;
}

.skeleton-line.shorter {
  width: 20%;
}

.skeleton-line.medium {
  width: 60%;
}

.skeleton-content {
  margin-bottom: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.skeleton-actions {
  display: flex;
  gap: 1rem;
  padding-top: 0.5rem;
}

.skeleton-btn {
  width: 4rem;
  height: 1.5rem;
  background: linear-gradient(90deg, var(--btn-bg) 25%, var(--btn-hover-bg) 50%, var(--btn-bg) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: 0.25rem;
}

@keyframes skeleton-loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

/* Twikoo åŠ è½½å®Œæˆåçš„å®¹å™¨æ ·å¼ */
:global(.twikoo) {
  animation: twikoo-fade-in 0.3s ease;
}

@keyframes twikoo-fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æš—é»‘æ¨¡å¼ä¸‹çš„è¯„è®ºæ ·å¼ä¼˜åŒ– */
:global(.twikoo),
:global(.tk-comments-container),
:global(.tk-expand),
:global(.tk-comment) {
  scroll-behavior: auto !important;
}

:global(.tk-main) {
  scroll-behavior: auto !important;
}

:global(.tk-submit) {
  scroll-behavior: auto !important;
}

/* é”™è¯¯æç¤ºæ ·å¼ */
.twikoo-error {
  text-align: center;
  padding: 2rem 1rem;
  color: var(--text-color);
}

.twikoo-error .error-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  opacity: 0.6;
}

.twikoo-error .error-title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-color);
}

.twikoo-error .error-desc {
  font-size: 0.875rem;
  color: var(--text-color);
  opacity: 0.7;
  margin-bottom: 1rem;
}

.twikoo-error .error-retry {
  padding: 0.5rem 1.5rem;
  background-color: var(--btn-bg);
  color: var(--text-color);
  border: 1px solid var(--line-divider);
  border-radius: var(--radius-small);
  cursor: pointer;
  font-size: 0.875rem;
  transition: background-color 0.2s ease;
}

.twikoo-error .error-retry:hover {
  background-color: var(--btn-hover-bg);
}
</style>