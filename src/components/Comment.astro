<div id="tcomment" class="twikoo-container"></div>

<script is:inline>
(function() {
  'use strict';
  
  // 配置
  var CONFIG = {
    envId: 'https://plbt.hhj520.top/',
    el: '#tcomment',
    lang: 'zh-CN',
    scriptUrl: 'https://s4.zstatic.net/ajax/libs/twikoo/1.6.41/twikoo.min.js'
  };
  
  // 标记是否已初始化
  var initialized = false;
  
  // 初始化 Twikoo
  function initTwikoo() {
    if (initialized) return;
    
    var container = document.getElementById('tcomment');
    if (!container) return;
    
    initialized = true;
    
    // 加载 Twikoo
    if (typeof twikoo === 'undefined') {
      var script = document.createElement('script');
      script.src = CONFIG.scriptUrl;
      script.async = true;
      script.onload = function() {
        runTwikoo();
      };
      script.onerror = function() {
        console.error('[Twikoo] Failed to load script');
      };
      document.head.appendChild(script);
    } else {
      runTwikoo();
    }
  }
  
  function runTwikoo() {
    try {
      twikoo.init({
        envId: CONFIG.envId,
        el: CONFIG.el,
        path: location.pathname,
        lang: CONFIG.lang,
        lazy: true,
        jumpToComment: false
      });
      console.log('[Twikoo] Initialized successfully');
    } catch (e) {
      console.error('[Twikoo] Init error:', e);
    }
  }
  
  // 使用 Intersection Observer 延迟加载
  if ('IntersectionObserver' in window) {
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          initTwikoo();
          observer.disconnect();
        }
      });
    }, { rootMargin: '100px' });
    
    var container = document.getElementById('tcomment');
    if (container) {
      observer.observe(container);
    }
  } else {
    // 降级处理
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTwikoo);
    } else {
      initTwikoo();
    }
  }
})();
</script>

<style scoped>
.twikoo-container {
  margin-top: 2rem;
  padding: 1.5rem;
  background-color: var(--card-bg);
  border-radius: var(--radius-large);
  border: 1px solid var(--line-divider);
  min-height: 100px;
}

/* 暗黑模式下的评论样式优化 */
:global(.twikoo),
:global(.tk-comments-container),
:global(.tk-expand),
:global(.tk-comment) {
  scroll-behavior: auto !important;
}

:global(.tk-main) {
  scroll-behavior: auto !important;
}

:global(.tk-submit) {
  scroll-behavior: auto !important;
}

/* 暗黑模式样式 - 强制覆盖 Twikoo 默认样式 */
:global(html.dark .twikoo) {
  --twikoo-bg-color: var(--card-bg) !important;
  --twikoo-text-color: var(--text-primary) !important;
  --twikoo-border-color: var(--line-divider) !important;
}

:global(html.dark .tk-comments-container) {
  background-color: var(--card-bg) !important;
  color: var(--text-primary) !important;
}

:global(html.dark .tk-comment) {
  background-color: var(--card-bg) !important;
  border-color: var(--line-divider) !important;
}

:global(html.dark .tk-content) {
  color: var(--text-primary) !important;
}

:global(html.dark .tk-nick) {
  color: var(--text-primary) !important;
}

:global(html.dark .tk-time) {
  color: var(--text-secondary) !important;
}

:global(html.dark .tk-input) {
  background-color: var(--input-bg) !important;
  color: var(--text-primary) !important;
  border-color: var(--line-divider) !important;
}

:global(html.dark .tk-textarea) {
  background-color: var(--input-bg) !important;
  color: var(--text-primary) !important;
  border-color: var(--line-divider) !important;
}

:global(html.dark .tk-preview) {
  background-color: var(--card-bg) !important;
  color: var(--text-primary) !important;
}

:global(html.dark .tk-action) {
  color: var(--text-secondary) !important;
}

:global(html.dark .tk-action-link) {
  color: var(--primary) !important;
}

:global(html.dark .tk-submit) {
  background-color: var(--primary) !important;
  color: white !important;
}

:global(html.dark .tk-cancel) {
  color: var(--text-secondary) !important;
}

:global(html.dark .tk-tag) {
  background-color: var(--primary-light) !important;
  color: var(--text-primary) !important;
}

:global(html.dark .tk-admin) {
  background-color: var(--primary) !important;
  color: white !important;
}

:global(html.dark .tk-avatar) {
  border-color: var(--line-divider) !important;
}

:global(html.dark .tk-replies) {
  background-color: var(--card-bg) !important;
  border-color: var(--line-divider) !important;
}

:global(html.dark .tk-reply) {
  border-color: var(--line-divider) !important;
}
</style>